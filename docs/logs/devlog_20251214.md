# 開発ログ 2025-12-14

## プロジェクト概要

**まごのTEC** - 高齢者向けスマホ相談チャットアプリ
- ターゲット: スマホ操作に不慣れな高齢者
- コンセプト: 「孫」が優しく教えてくれる
- フロントエンド: HTML/CSS/JS（GitHub Pages）
- バックエンド: Python/FastAPI + OpenAI GPT-4o（Render）

---

## 重要な前提条件（必ず記憶）

| 項目 | 内容 |
|------|------|
| **Renderプラン** | **課金済み**（無料プランではない） |
| **ターゲットユーザー** | 高齢者（大きいボタン、やさしい言葉遣い必須） |
| **Enter動作** | 改行（LINEと同じ仕様）、送信はボタンのみ |

---

## 本日のデプロイ作業

### 1. magonotec-api（バックエンド）
- `.gitignore` 追加（`venv/`, `.env` を除外）
- Render にデプロイ完了
- **本番URL**: https://magonotec-api.onrender.com

### 2. magonotec-app（フロントエンド）
- API接続先を `localhost:8000` → 本番URLに変更
- GitHub Pages にデプロイ完了
- **本番URL**: https://aoikuruma23.github.io/magonotec-app/

---

## 本日実装した機能

### STEP17: 会話履歴の永続化
- localStorageに保存、ブラウザを閉じても残る

### STEP18: PWAインストール案内
- 初回AI返信後に「ねぇねぇ！すぐに会えるように、ホーム画面に登録しておかない？」と案内
- iOS: Safari共有メニューの案内表示
- Android: beforeinstallpromptイベントでインストール

### STEP19: レート制限
- バックエンド: slowapiで1分間10回まで（IPアドレスごと）
- フロントエンド: 制限時は「たくさんお話しすぎちゃったみたい」メッセージ

### STEP20: ローディング・エラー・タイムアウト
- **ローディング表示**: 「考え中...」（ドットアニメーション付き）
- **リトライボタン**: エラー時に「もう一度試す」ボタン表示
- **タイムアウト**: 60秒で通信中断、やさしいエラーメッセージ表示

### その他の修正
- scrollIntoView修正（`inline: 'nearest'`が鍵）
- Enter=改行、送信ボタンのみで送信（LINE仕様）
- 送信した画像をチャット内に表示（返信後も残る）
- テスターガイド作成（docs/tester_guide.md）

---

## 学習記録: scrollIntoView の正しい使い方

### 問題
チャットの返信が表示されたとき、メッセージの**末尾**が表示されてしまい、先頭が見えない。

### 正解
```javascript
lastMessage.scrollIntoView({ block: 'start', inline: 'nearest', behavior: 'auto' });
```

### ポイント
- `inline: 'nearest'` で横スクロールの干渉を防ぐ（重要）
- `behavior: 'auto'` で確実にスクロール

---

## 環境変数（Render）

| Key | Value | 必須 |
|-----|-------|------|
| `OPENAI_API_KEY` | OpenAI APIキー | 必須 |
| `ALLOWED_ORIGINS` | `https://aoikuruma23.github.io` | 必須 |
| `OPENAI_MODEL` | `gpt-4o-mini` | 任意 |

---

## ファイル構成

### magonotec-app（フロントエンド）
```
C:\Users\yukih\magonotec-app\
├── index.html          # メインHTML
├── manifest.json       # PWA設定
├── css/
│   └── styles.css      # スタイル
├── js/
│   └── main.js         # メインロジック（約1400行）
├── images/             # キャラクター画像
└── docs/
    ├── tester_guide.md # テスター向けガイド
    └── logs/           # 開発ログ
```

### magonotec-api（バックエンド）
```
C:\Users\yukih\magonotec-api\
├── app/
│   └── main.py         # FastAPI（約330行）
├── requirements.txt    # 依存関係
└── .env                # 環境変数（gitignore済み）
```

---

## 現在の状態

- **テスト可能状態**: 数人にテスト依頼可能
- **セキュリティ**: レート制限、CORS設定済み
- **未実装**: ローカル/本番のAPI_BASE_URL自動切り替え（低優先度）

---

## 次回作業候補

1. テスターからのフィードバック対応
2. 追加機能の検討（ユーザーからの要望次第）
3. 本番環境の監視・ログ確認

---

## 復活の呪文

次回セッション開始時に以下をコピペしてください：

```
まごのTECプロジェクトの作業を再開します。

【プロジェクト概要】
- 高齢者向けスマホ相談チャットアプリ
- フロントエンド: https://aoikuruma23.github.io/magonotec-app/
- バックエンド: https://magonotec-api.onrender.com（Render課金済み）

【重要な前提】
- Renderは課金プラン（無料プランの話は不要）
- ターゲットは高齢者（大きいボタン、やさしい言葉遣い）
- Enter=改行、送信ボタンのみで送信（LINE仕様）

【現在の状態】
- デプロイ完了、テスト可能状態
- 実装済み: PWA対応、レート制限、ローディング表示、リトライボタン、タイムアウト処理（60秒）

【ローカルパス】
- フロントエンド: C:\Users\yukih\magonotec-app
- バックエンド: C:\Users\yukih\magonotec-api

作業ログ: docs/logs/devlog_20251214.md を読んでから作業開始してください。
```
